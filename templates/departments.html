{% extends "base.html" %}
{% block title %}Departments{% endblock %}
{% block content %}

{% block subnav %}
	{% include "subnav.html" %}
{% endblock %}


{% if session['role'] == 'manager' %}
<h1>Departments</h1>
{% elif session['role'] == 'admin' %}
<div class="d-flex justify-content-between align-items-center mt-3 mb-3">
	<h1>Departments</h1>
	<a href="#addDepartmentSection" id="toggleAddDepartmentBtn" class="btn btn-success"
	   data-bs-toggle="collapse" data-bs-target="#departmentTable,#addDepartmentSection"
	   aria-expanded="false">
		<i class="bi bi-plus-circle"></i> Add Department
	</a>
</div>

{% with messages = get_flashed_messages(with_categories=true) %}
	{% if messages %}
		{% for category, msg in messages %}
			<div class="alert alert-{{ category }} mt-2">{{ msg }}</div>
		{% endfor %}
	{% endif %}
{% endwith %}

<!-- Add Department Section -->
<div class="collapse" id="addDepartmentSection">
	<h2>Add Department</h2>

	<div class="card mb-4">
		<div class="card-body">
			<form method="post">
				<div class="row g-3">
					<div class="col-md-6">
						<label for="name" class="form-label">Department Name *</label>
						<input id="name" name="name" class="form-control" required>
					</div>

					<div class="col-md-6">
						<label for="manager_id" class="form-label">Manager</label>
						<select id="manager_id" name="manager_id" class="form-select">
							<option value="">-- No Manager --</option>
							{% for emp in employees %}
								<option value="{{ emp.employee_id }}">
									{{ emp.first_name }} {{ emp.last_name }}
								</option>
							{% endfor %}
						</select>
					</div>
				</div>

				<div class="mt-4">
					<button type="submit" class="btn btn-success">Add Department</button>
				</div>
			</form>
		</div>
	</div>
</div>
{% endif %}


<!-- Departments Table -->
<div class="collapse show" id="departmentTable">

	<!-- Search Bar -->
	<form method="get" action="{{ url_for('department.departments') }}" class="mb-3 d-flex">
	<input type="text" name="search" class="form-control me-2"
	       placeholder="Search departments..."
	       value="{{ request.args.get('search', '') }}">
	<button type="submit" class="btn btn-primary">Search</button>
	</form>

	<table class="table table-striped align-middle">
		<thead class="table-light">
			<tr>
				{% set columns = [
					('department_id', 'ID'),
					('name', 'Name'),
					('manager_id', 'Manager')
				] %}
				{% for field, label in columns %}
					<th class="fw-bold text-nowrap">
						<a href="?sort={{ field }}&direction={{ 'desc' if sort == field and direction == 'asc' else 'asc' }}&search={{ request.args.get('search', '') }}"
   							class="text-dark text-decoration-none text-nowrap">
							{{ label }}
							{% if sort == field %}
								{{ '↑' if direction == 'asc' else '↓' }}
							{% endif %}
						</a>
					</th>
				{% endfor %}
				{% if session['role'] == 'admin' %}
				<th class="fw-bold text-nowrap">Actions</th>
				{% endif %}
			</tr>
		</thead>
		<tbody>
			{% for department in departments %}
				<tr>
					<td>{{ department.department_id }}</td>
					<td>{{ department.name }}</td>
					<td>
						{% if department.manager_id %}
							{% set manager = employees | selectattr("employee_id", "equalto", department.manager_id) | first %}
							{{ manager.first_name }} {{ manager.last_name }}
						{% else %}
							-
						{% endif %}
					</td>
					{% if session['role'] == 'admin' %}
					<td>
						<!-- Collapsible Button -->
						<a class="btn btn-sm btn-secondary"
						   data-bs-toggle="collapse"
						   href="#editDepartment{{ department.department_id }}"
						   role="button"
						   aria-expanded="false"
						   aria-controls="editDepartment{{ department.department_id }}">
							Edit
						</a>
						<!-- Delete Button -->
						<a href="/departments/delete/{{ department.department_id }}" class="btn btn-sm btn-danger">Delete</a>
					</td>
					{% endif %}
				</tr>
				<!-- Collapsible edit form row -->
			<tr class="collapse" id="editDepartment{{ department.department_id }}">
				<td colspan="3">
					<div class="card card-body">
						<form method="post" action="/departments/edit/{{ department.department_id }}">
						<div class="row g-3">
							<div class="col-md-6">
								<label for="department_name_{{ department.department_id }}" class="form-label">Department Name</label>
								<input type="text"
									   id="department_name_{{ department.department_id }}"
									   name="department_name"
									   class="form-control"
									   value="{{ department.name }}"
									   required>
							</div>

							<div class="col-md-6">
								<label for="manager_id_{{ department.department_id }}" class="form-label">Manager</label>
								<select id="manager_id_{{ department.department_id }}" name="manager_id" class="form-select">
									<option value="">-- No Manager --</option>
									{% for employee in employees %}
										<option value="{{ employee.employee_id }}"
											{% if employee.employee_id == department.manager_id %}selected{% endif %}>
											{{ employee.first_name }} {{ employee.last_name }}
										</option>
									{% endfor %}
								</select>
							</div>
						</div>

	<div class="mt-3">
		<button type="submit" class="btn btn-sm btn-success">Save</button>
	</div>
</form>


					</div>
				</td>
			</tr>
			{% endfor %}
		</tbody>
	</table>
</div>

{% endblock %}
