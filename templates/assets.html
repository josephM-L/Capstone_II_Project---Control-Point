{% extends "base.html" %}
{% block title %}Assets{% endblock %}
{% block content %}

{% block subnav %}
	{% include "subnav.html" %}
{% endblock %}

{% if session['role'] == 'user' %}
<h1>Assets</h1>
{% elif session['role'] == 'manager' or session['role'] == 'admin' %}
<div class="d-flex justify-content-between align-items-center mt-3 mb-3">
	<h1>Assets</h1>
	<a href="#addAssetSection" id="toggleAddAssetBtn" class="btn btn-success"
	   data-bs-toggle="collapse" data-bs-target="#assetTable,#addAssetSection"
	   aria-expanded="false">
		<i class="bi bi-plus-circle"></i> Add Asset
	</a>
</div>

{% with messages = get_flashed_messages(with_categories=true) %}
	{% if messages %}
		{% for category, msg in messages %}
			<div class="alert alert-{{ category }} mt-2">{{ msg }}</div>
		{% endfor %}
	{% endif %}
{% endwith %}

<!-- Add Asset Section -->
<div class="collapse" id="addAssetSection">
	<h2>Add Asset</h2>

	<!-- CSV Upload -->
	<div class="card mb-4">
		<div class="card-body">
			<h5>Upload from CSV</h5>
			<form action="{{ url_for('assets.assets') }}" method="POST" enctype="multipart/form-data">
				<div class="mb-3">
					<input type="file" class="form-control" id="csv_file" name="csv_file" accept=".csv" required>
					<div class="form-text">Only .csv files are supported.</div>
				</div>
				<button type="submit" class="btn btn-primary">Upload CSV</button>
			</form>
		</div>
	</div>

	<!-- Manual Entry -->
	<div class="card mb-4">
		<div class="card-body">
			<h5>Enter Data Manually</h5>
			<form method="post">
				<div class="row g-3">
					<div class="col-md-6">
						<label for="asset_tag" class="form-label">Asset Tag *</label>
						<input id="asset_tag" name="asset_tag" class="form-control" required>
					</div>

					<div class="col-md-6">
						<label for="name" class="form-label">Name *</label>
						<input id="name" name="name" class="form-control" required>
					</div>

					<div class="col-12">
						<label for="description" class="form-label">Description</label>
						<textarea id="description" name="description" class="form-control"></textarea>
					</div>

					<div class="col-md-6">
						<label for="purchase_date" class="form-label">Purchase Date</label>
						<input id="purchase_date" name="purchase_date" type="date" class="form-control">
					</div>

					<div class="col-md-6">
						<label for="purchase_cost" class="form-label">Purchase Cost</label>
						<input id="purchase_cost" name="purchase_cost" type="number" step="0.01" class="form-control">
					</div>

					<div class="col-md-6">
						<label for="serial_number" class="form-label">Serial Number</label>
						<input id="serial_number" name="serial_number" class="form-control">
					</div>

					<div class="col-md-6">
						<label for="warranty_expiry" class="form-label">Warranty Expiry</label>
						<input id="warranty_expiry" name="warranty_expiry" type="date" class="form-control">
					</div>

					<!-- Dropdowns -->
					<div class="col-md-6">
						<label for="asset_type_id" class="form-label">Asset Type</label>
						<select id="asset_type_id" name="asset_type_id" class="form-select">
							<option value="">-- Select Type --</option>
							{% for t in asset_types %}
								<option value="{{ t.asset_type_id }}">{{ t.name }}</option>
							{% endfor %}
						</select>
					</div>

					<div class="col-md-6">
						<label for="status_id" class="form-label">Status</label>
						<select id="status_id" name="status_id" class="form-select">
							<option value="">-- Select Status --</option>
							{% for s in statuses %}
								<option value="{{ s.status_id }}">{{ s.status_name }}</option>
							{% endfor %}
						</select>
					</div>

					<div class="col-md-6">
						<label for="location_id" class="form-label">Location</label>
						<select id="location_id" name="location_id" class="form-select">
							<option value="">-- Select Location --</option>
							{% for loc in locations %}
								<option value="{{ loc.location_id }}">{{ loc.name }}</option>
							{% endfor %}
						</select>
					</div>

					<div class="col-md-6">
						<label for="vendor_id" class="form-label">Vendor</label>
						<select id="vendor_id" name="vendor_id" class="form-select">
							<option value="">-- Select Vendor --</option>
							{% for v in vendors %}
								<option value="{{ v.vendor_id }}">{{ v.name }}</option>
							{% endfor %}
						</select>
					</div>

					<div class="col-md-6">
						<label for="assigned_to" class="form-label">Assigned Employee</label>
						<select id="assigned_to" name="assigned_to" class="form-select">
							<option value="">-- Select Employee --</option>
							{% for e in employees %}
								<option value="{{ e.employee_id }}">{{ e.first_name }} {{ e.last_name }}</option>
							{% endfor %}
						</select>
					</div>
				</div>

				<div class="mt-4">
					<button type="submit" class="btn btn-success">Add Asset</button>
				</div>
			</form>
		</div>
	</div>
</div>

{% endif %}

<!-- Assets Table -->
<div class="collapse show" id="assetTable">

	<!-- Search Bar -->
	<form method="get" action="{{ url_for('assets.assets') }}" class="mb-3 d-flex">
	<input type="text" name="search" class="form-control me-2"
	       placeholder="Search assets..."
	       value="{{ request.args.get('search', '') }}">
	<button type="submit" class="btn btn-primary">Search</button>
	</form>


	<table class="table table-striped align-middle">
		<thead class="table-light">
			<tr>
				{% set columns = [
					('asset_id', 'ID'),
					('asset_tag', 'Tag'),
					('name', 'Name'),
					('description', 'Description'),
					('purchase_date', 'Purchase Date'),
					('purchase_cost', 'Cost'),
					('serial_number', 'Serial Number'),
					('warranty_expiry', 'Warranty Expiry'),
					('asset_type_id', 'Type'),
					('status_id', 'Status'),
					('location_id', 'Location'),
					('vendor_id', 'Vendor'),
					('assigned_to', 'Assigned To')
				] %}
				{% for field, label in columns %}
					<th class="fw-bold text-nowrap">
						<a href="?sort={{ field }}&direction={{ 'desc' if sort == field and direction == 'asc' else 'asc' }}&search={{ request.args.get('search', '') }}"
   							class="text-dark text-decoration-none text-nowrap">
							{{ label }}
							{% if sort == field %}
								{{ '↑' if direction == 'asc' else '↓' }}
							{% endif %}
						</a>
					</th>
				{% endfor %}
				{% if session['role'] == 'manager' or session['role'] == 'admin' %}
				<th class="fw-bold text-nowrap">Actions</th>
				{% endif %}
			</tr>
		</thead>
		<tbody>
			{% for asset in assets %}
				<tr>
					<td>{{ asset.asset_id }}</td>
					<td>{{ asset.asset_tag }}</td>
					<td>{{ asset.name }}</td>
					<td>{{ asset.description or '' }}</td>
					<td>{{ asset.purchase_date or '' }}</td>
					<td>{{ asset.purchase_cost or '' }}</td>
					<td>{{ asset.serial_number or '' }}</td>
					<td>{{ asset.warranty_expiry or '' }}</td>
					<td>{{ asset.asset_type.name if asset.asset_type else '' }}</td>
					<td>{{ asset.status.status_name if asset.status else '' }}</td>
					<td>{{ asset.location.name if asset.location else '' }}</td>
					<td>{{ asset.vendor.name if asset.vendor else '' }}</td>
					<td>
						{% if asset.assigned_employee %}
							{{ asset.assigned_employee.first_name }} {{ asset.assigned_employee.last_name }}
						{% endif %}
					</td>
					{% if session['role'] == 'manager' or session['role'] == 'admin' %}
					<td>
						<!-- Collapsible Button -->
						<a class="btn btn-sm btn-secondary"
						   data-bs-toggle="collapse"
						   href="#editAsset{{ asset.asset_id }}"
						   role="button"
						   aria-expanded="false"
						   aria-controls="editAsset{{ asset.asset_id }}">
							Edit
						</a>
						<!-- Delete Button -->
						<a href="/assets/delete/{{ asset.asset_id }}" class="btn btn-sm btn-danger">Delete</a>
					</td>
					{% endif %}
				</tr>

			<!-- Collapsible edit form row -->
			<tr class="collapse" id="editAsset{{ asset.asset_id }}">
				<td colspan="10">
					<div class="card card-body">
						<form method="post" action="/assets/edit/{{ asset.asset_id }}">
							<div class="row g-3">

								<div class="col-md-4">
									<label for="asset_tag_{{ asset.asset_id }}" class="form-label">Asset Tag</label>
									<input type="text" id="asset_tag_{{ asset.asset_id }}" name="asset_tag"
										   class="form-control" value="{{ asset.asset_tag }}" required>
								</div>

								<div class="col-md-4">
									<label for="name_{{ asset.asset_id }}" class="form-label">Name</label>
									<input type="text" id="name_{{ asset.asset_id }}" name="name"
										   class="form-control" value="{{ asset.name }}" required>
								</div>

								<div class="col-md-4">
									<label for="serial_number_{{ asset.asset_id }}" class="form-label">Serial Number</label>
									<input type="text" id="serial_number_{{ asset.asset_id }}" name="serial_number"
										   class="form-control" value="{{ asset.serial_number }}">
								</div>

								<div class="col-md-6">
									<label for="asset_type_id_{{ asset.asset_id }}" class="form-label">Asset Type</label>
									<select id="asset_type_id_{{ asset.asset_id }}" name="asset_type_id" class="form-select">
										{% for type in asset_types %}
											<option value="{{ type.asset_type_id }}"
												{% if asset.asset_type_id == type.asset_type_id %}selected{% endif %}>
												{{ type.name }}
											</option>
										{% endfor %}
									</select>
								</div>

								<div class="col-md-6">
									<label for="status_id_{{ asset.asset_id }}" class="form-label">Status</label>
									<select id="status_id_{{ asset.asset_id }}" name="status_id" class="form-select">
										{% for status in statuses %}
											<option value="{{ status.status_id }}"
												{% if asset.status_id == status.status_id %}selected{% endif %}>
												{{ status.status_name }}
											</option>
										{% endfor %}
									</select>
								</div>

								<div class="col-md-6">
									<label for="location_id_{{ asset.asset_id }}" class="form-label">Location</label>
									<select id="location_id_{{ asset.asset_id }}" name="location_id" class="form-select">
										{% for loc in locations %}
											<option value="{{ loc.location_id }}"
												{% if asset.location_id == loc.location_id %}selected{% endif %}>
												{{ loc.name }}
											</option>
										{% endfor %}
									</select>
								</div>

								<div class="col-md-6">
									<label for="assigned_to_{{ asset.asset_id }}" class="form-label">Assigned To</label>
									<select id="assigned_to_{{ asset.asset_id }}" name="assigned_to" class="form-select">
										<option value="">-- None --</option>
										{% for emp in employees %}
											<option value="{{ emp.employee_id }}"
												{% if asset.assigned_to == emp.employee_id %}selected{% endif %}>
												{{ emp.first_name }} {{ emp.last_name }}
											</option>
										{% endfor %}
									</select>
								</div>

								<div class="col-md-6">
									<label for="vendor_id_{{ asset.asset_id }}" class="form-label">Vendor</label>
									<select id="vendor_id_{{ asset.asset_id }}" name="vendor_id" class="form-select">
										{% for vendor in vendors %}
											<option value="{{ vendor.vendor_id }}"
												{% if asset.vendor_id == vendor.vendor_id %}selected{% endif %}>
												{{ vendor.name }}
											</option>
										{% endfor %}
									</select>
								</div>

								<div class="col-md-3">
									<label for="purchase_date_{{ asset.asset_id }}" class="form-label">Purchase Date</label>
									<input type="date" id="purchase_date_{{ asset.asset_id }}" name="purchase_date"
										   class="form-control"
										   value="{{ asset.purchase_date.strftime('%Y-%m-%d') if asset.purchase_date }}">
								</div>

								<div class="col-md-3">
									<label for="warranty_expiry_{{ asset.asset_id }}" class="form-label">Warranty Expiry</label>
									<input type="date" id="warranty_expiry_{{ asset.asset_id }}" name="warranty_expiry"
										   class="form-control"
										   value="{{ asset.warranty_expiry.strftime('%Y-%m-%d') if asset.warranty_expiry }}">
								</div>

								<div class="col-md-3">
									<label for="purchase_cost_{{ asset.asset_id }}" class="form-label">Purchase Cost</label>
									<input type="number" step="0.01" id="purchase_cost_{{ asset.asset_id }}" name="purchase_cost"
										   class="form-control" value="{{ asset.purchase_cost }}">
								</div>

								<div class="col-md-12">
									<label for="description_{{ asset.asset_id }}" class="form-label">Description</label>
									<textarea id="description_{{ asset.asset_id }}" name="description"
											  class="form-control" rows="2">{{ asset.description }}</textarea>
								</div>

							</div>

							<div class="mt-3">
								<button type="submit" class="btn btn-sm btn-success">Save</button>
							</div>
						</form>
					</div>
				</td>
			</tr>


			{% endfor %}
		</tbody>
	</table>
</div>

{% endblock %}
