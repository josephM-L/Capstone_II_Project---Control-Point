{% extends "base.html" %}
{% block title %}Asset Disposals{% endblock %}
{% block content %}

{% block subnav %}
	{% include "subnav.html" %}
{% endblock %}

<div class="d-flex justify-content-between align-items-center mt-3 mb-3">
	<h1>Asset Disposals</h1>
	<a href="#addDisposalSection" id="toggleAddDisposalBtn" class="btn btn-success"
	   data-bs-toggle="collapse" data-bs-target="#disposalTable,#addDisposalSection"
	   aria-expanded="false">
		<i class="bi bi-plus-circle"></i> Add Disposal
	</a>
</div>

{% with messages = get_flashed_messages(with_categories=true) %}
	{% if messages %}
		{% for category, msg in messages %}
			<div class="alert alert-{{ category }} mt-2">{{ msg }}</div>
		{% endfor %}
	{% endif %}
{% endwith %}

<!-- Add Disposal Section -->
<div class="collapse" id="addDisposalSection">
	<h2>Add Asset Disposal</h2>

	<!-- CSV Upload -->
	<div class="card mb-4">
		<div class="card-body">
			<h5>Upload from CSV</h5>
			<form action="{{ url_for('asset_disposal.asset_disposals') }}" method="POST" enctype="multipart/form-data">
				<div class="mb-3">
					<input type="file" class="form-control" id="csv_file" name="csv_file" accept=".csv" required>
					<div class="form-text">Only .csv files are supported.</div>
				</div>
				<button type="submit" class="btn btn-primary">Upload CSV</button>
			</form>
		</div>
	</div>

	<div class="card mb-4">
		<div class="card-body">
			<form method="post">
				<div class="row g-3">
					<div class="col-md-6">
						<label for="asset_id" class="form-label">Asset *</label>
						<select id="asset_id" name="asset_id" class="form-select" required>
							{% for asset in assets %}
								<option value="{{ asset.asset_id }}">{{ asset.asset_tag }} - {{ asset.name }}</option>
							{% endfor %}
						</select>
					</div>

					<div class="col-md-6">
						<label for="disposal_date" class="form-label">Disposal Date *</label>
						<input id="disposal_date" name="disposal_date" type="date" class="form-control" required>
					</div>

					<div class="col-md-6">
						<label for="method" class="form-label">Method *</label>
						<select id="method" name="method" class="form-select" required>
							<option value="Sold">Sold</option>
							<option value="Recycled">Recycled</option>
							<option value="Scrapped">Scrapped</option>
							<option value="Donated">Donated</option>
						</select>
					</div>

					<div class="col-md-3">
						<label for="sale_value" class="form-label">Sale Value</label>
						<input id="sale_value" name="sale_value" type="number" step="0.01" class="form-control">
					</div>

					<div class="col-md-3">
						<label for="notes" class="form-label">Notes</label>
						<input id="notes" name="notes" class="form-control">
					</div>
				</div>

				<div class="mt-4">
					<button type="submit" class="btn btn-success">Add Disposal</button>
				</div>
			</form>
		</div>
	</div>
</div>

<!-- Disposal Table -->
<div class="collapse show" id="disposalTable">

	<!-- Search Bar -->
	<form method="get" action="{{ url_for('asset_disposal.asset_disposals') }}" class="mb-3 d-flex">
	<input type="text" name="search" class="form-control me-2"
	       placeholder="Search asset disposals..."
	       value="{{ request.args.get('search', '') }}">
	<button type="submit" class="btn btn-primary">Search</button>
	</form>

	<table class="table table-striped align-middle">
		<thead class="table-light">
			<tr>
				{% set columns = [
					('disposal_id', 'ID'),
					('asset.asset_tag', 'Asset'),
					('disposal_date', 'Disposal Date'),
					('method', 'Method'),
					('sale_value', 'Sale Value'),
					('notes', 'Notes')
				] %}
				{% for field, label in columns %}
					<th class="fw-bold text-nowrap">
						<a href="?sort={{ field }}&direction={{ 'desc' if sort == field and direction == 'asc' else 'asc' }}&search={{ request.args.get('search', '') }}"
   							class="text-dark text-decoration-none text-nowrap">
							{{ label }}
							{% if sort == field %}
								{{ '↑' if direction == 'asc' else '↓' }}
							{% endif %}
						</a>
					</th>
				{% endfor %}
				<th class="fw-bold text-nowrap">Actions</th>
			</tr>
		</thead>
		<tbody>
			{% for disposal in disposals %}
				<tr>
					<td>{{ disposal.disposal_id }}</td>
					<td><a href="{{ url_for('assets.assets', search=disposal.asset.asset_tag) }}">
						{{ disposal.asset.asset_tag }}
					</a></td>
					<td>{{ disposal.disposal_date }}</td>
					<td>{{ disposal.method }}</td>
					<td>{{ disposal.sale_value or '' }}</td>
					<td>{{ disposal.notes or '' }}</td>
					<td>
						<!-- Collapsible Button -->
						<a class="btn btn-sm btn-secondary"
						   data-bs-toggle="collapse"
						   href="#editAssetDisposal{{ disposal.disposal_id }}"
						   role="button"
						   aria-expanded="false"
						   aria-controls="editAssetDisposal{{ disposal.disposal_id }}">
							Edit
						</a>
						<!-- Delete Button -->
						<a href="/asset_disposals/delete/{{ disposal.disposal_id }}" class="btn btn-sm btn-danger">Delete</a>
					</td>
				</tr>

				<!-- Collapsible edit form row -->
				<tr class="collapse" id="editAssetDisposal{{ disposal.disposal_id }}">
					<td colspan="6">
						<div class="card card-body">
							<form method="post" action="/asset_disposals/edit/{{ disposal.disposal_id }}">
								<div class="row g-3">

									<div class="col-md-4">
										<label for="disposal_date_{{ disposal.disposal_id }}" class="form-label">Disposal Date</label>
										<input type="date" id="disposal_date_{{ disposal.disposal_id }}" name="disposal_date"
											   class="form-control" value="{{ disposal.disposal_date }}" required>
									</div>

									<div class="col-md-4">
										<label for="method_{{ disposal.disposal_id }}" class="form-label">Method</label>
										<select id="method_{{ disposal.disposal_id }}" name="method" class="form-select" required>
											{% for option in ["Sold", "Recycled", "Scrapped", "Donated"] %}
												<option value="{{ option }}" {% if disposal.method == option %}selected{% endif %}>
													{{ option }}
												</option>
											{% endfor %}
										</select>
									</div>

									<div class="col-md-4">
										<label for="sale_value_{{ disposal.disposal_id }}" class="form-label">Sale Value</label>
										<input type="number" step="0.01" id="sale_value_{{ disposal.disposal_id }}" name="sale_value"
											   class="form-control" value="{{ disposal.sale_value or '' }}">
									</div>

									<div class="col-md-12">
										<label for="notes_{{ disposal.disposal_id }}" class="form-label">Notes</label>
										<textarea id="notes_{{ disposal.disposal_id }}" name="notes" class="form-control"
												  rows="2">{{ disposal.notes or '' }}</textarea>
									</div>
								</div>

								<div class="mt-3">
									<button type="submit" class="btn btn-sm btn-success">Save</button>
								</div>
							</form>
						</div>
					</td>
				</tr>


			{% endfor %}
		</tbody>
	</table>
</div>

{% endblock %}
