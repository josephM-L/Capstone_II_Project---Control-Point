{% extends "base.html" %}
{% block title %}Asset Maintenance{% endblock %}
{% block content %}

{% block subnav %}
	{% include "subnav.html" %}
{% endblock %}

<div class="d-flex justify-content-between align-items-center mt-3 mb-3">
	<h1>Asset Maintenance</h1>
	<a href="#addMaintenanceSection" id="toggleAddMaintenanceBtn" class="btn btn-success"
	   data-bs-toggle="collapse" data-bs-target="#maintenanceTable,#addMaintenanceSection"
	   aria-expanded="false">
		<i class="bi bi-plus-circle"></i> Add Maintenance
	</a>
</div>

{% with messages = get_flashed_messages(with_categories=true) %}
	{% if messages %}
		{% for category, msg in messages %}
			<div class="alert alert-{{ category }} mt-2">{{ msg }}</div>
		{% endfor %}
	{% endif %}
{% endwith %}

<!-- Add Maintenance Section -->
<div class="collapse" id="addMaintenanceSection">
	<h2>Add Maintenance Record</h2>

	<div class="card mb-4">
		<div class="card-body">
			<form method="post">
				<div class="row g-3">
					<div class="col-md-6">
						<label for="asset_id" class="form-label">Asset *</label>
						<select id="asset_id" name="asset_id" class="form-select" required>
							{% for asset in assets %}
								<option value="{{ asset.asset_id }}">{{ asset.asset_tag }} - {{ asset.name }}</option>
							{% endfor %}
						</select>
					</div>

					<div class="col-md-6">
						<label for="maintenance_date" class="form-label">Maintenance Date *</label>
						<input id="maintenance_date" name="maintenance_date" type="date" class="form-control" required>
					</div>

					<div class="col-md-12">
						<label for="description" class="form-label">Description</label>
						<textarea id="description" name="description" class="form-control"></textarea>
					</div>

					<div class="col-md-6">
						<label for="performed_by" class="form-label">Performed By</label>
						<input id="performed_by" name="performed_by" class="form-control">
					</div>

					<div class="col-md-3">
						<label for="cost" class="form-label">Cost</label>
						<input id="cost" name="cost" type="number" step="0.01" class="form-control">
					</div>

					<div class="col-md-3">
						<label for="next_due_date" class="form-label">Next Due Date</label>
						<input id="next_due_date" name="next_due_date" type="date" class="form-control">
					</div>
				</div>

				<div class="mt-4">
					<button type="submit" class="btn btn-success">Add Maintenance</button>
				</div>
			</form>
		</div>
	</div>
</div>

<!-- Maintenance Table -->
<div class="collapse show" id="maintenanceTable">
	<table class="table table-striped align-middle">
		<thead class="table-light">
			<tr>
				{% set columns = [
					('maintenance_id', 'ID'),
					('asset.asset_tag', 'Asset'),
					('maintenance_date', 'Date'),
					('description', 'Description'),
					('performed_by', 'Performed By'),
					('cost', 'Cost'),
					('next_due_date', 'Next Due')
				] %}
				{% for field, label in columns %}
					<th class="fw-bold text-nowrap">
						<a href="?sort={{ field }}&direction={{ 'desc' if sort == field and direction == 'asc' else 'asc' }}"
						   class="text-dark text-decoration-none text-nowrap">
							{{ label }}
							{% if sort == field %}
								{{ '↑' if direction == 'asc' else '↓' }}
							{% endif %}
						</a>
					</th>
				{% endfor %}
				<th class="fw-bold text-nowrap">Actions</th>
			</tr>
		</thead>
		<tbody>
			{% for maintenance in maintenances %}
				<tr>
					<td>{{ maintenance.maintenance_id }}</td>
					<td>{{ maintenance.asset.asset_tag }} - {{ maintenance.asset.name }}</td>
					<td>{{ maintenance.maintenance_date }}</td>
					<td>{{ maintenance.description or '' }}</td>
					<td>{{ maintenance.performed_by or '' }}</td>
					<td>{{ maintenance.cost or '' }}</td>
					<td>{{ maintenance.next_due_date or '' }}</td>
					<td>
						<a href="/asset_maintenance/delete/{{ maintenance.maintenance_id }}" class="btn btn-sm btn-danger">Delete</a>
					</td>
				</tr>
			{% endfor %}
		</tbody>
	</table>
</div>

{% endblock %}
